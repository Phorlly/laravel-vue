<template xmlns = "http://www.w3.org/1999/html">
    <div>
        <!-- Content Header (Page header) -->
        <div class = "content-header">
            <div class = "container-fluid">
                <div class = "row mb-2">
                    <div class = "col-sm-6">
                        <h1 class = "m-0 text-uppercase">·ûñ·ûè·üå·ûò·û∂·ûì·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö</h1>
                    </div>
                    <!-- /.col -->
                    <div class = "col-sm-6">
                        <ol class = "breadcrumb float-sm-right">
                            <li class = "breadcrumb-item">
                                <a href = "/home">·ûë·üÜ·ûñ·üê·ûö·ûä·ûæ·ûò</a>
                            </li>
                            <li class = "breadcrumb-item active">·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö</li>
                        </ol>
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class = "content">
            <div class = "container-fluid card">
                <!-- Small boxes (Stat box) -->
                <div class = "row card-body">
                    <div class = "col-12">
                        <!-- /.card-header -->
                        <div class = "card-header">
                            <div class = "card-title">
                                <button
                                    type = "button"
                                    class = "btn btn-sm btn-primary"
                                    @click = "addNew"
                                >
                                    <i class = "fas fa-plus"></i> ·ûî·ûì·üí·ûê·üÇ·ûò·ûê·üí·ûò·û∏
                                </button>
                                <!--                        data-toggle = "modal" data-target = "#customer-modal"-->
                            </div>

                            <div class = "card-tools">
                                <button
                                    type = "button"
                                    class = "btn btn-sm btn-danger"
                                    @click = "refreshData"
                                >
                                    <i class = "fas fa-sync-alt"></i> ·ûë·û∂·ûâ·ûò·üí·ûä·ûÑ·ûë·üÄ·ûè
                                </button>
                            </div>
                        </div>

                        <div class = "table-responsive">
                            <dataTable ref="myTable"  :data="datas" :columns="columns" class="table table-striped table-bordered"
                                :options="{
                                    responsive: true, autoWith: false, dom: 'Bfrtip',
                                     language:{ paginate: {
                                        previous: `<i class='fas fa-caret-square-left'> </i>`,
                                        next: `<i class=' fas fa-caret-square-right'> </i>`
                                    }
                                },
                                buttons: buttons
                                }">
                            </dataTable>
                        </div>

                    </div>
                    <!-- ./col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </section>
        <!-- /.content -->

        <!-- modal dialog-->
        <div class = "modal fade" id = "data-modal" aria-modal = "true" role = "dialog">
            <div class = "modal-dialog">
                <div class = "modal-content">
                    <div class = "modal-header">
                        <h4 class = "modal-title text-center">
                            ·ûñ·ûè·üå·ûò·û∂·ûì·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö
                        </h4>
                        <button
                            type = "button"
                            class = "close"
                            data-dismiss = "modal"
                            aria-label = "Close"
                        >
                            <span aria-hidden = "true">√ó</span>
                        </button>
                    </div>

                    <div class = "modal-body">
                        <form
                            @submit.prevent = "method ? updateData() : saveData()"
                        >
                            <div class = "row">
                                <div class = "col-md-12">
                                    <div class = "form-group">
                                        <label for = "name"
                                        >·ûà·üí·ûò·üÑ·üá·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö</label
                                        >
                                        <input
                                            type = "text"
                                            class = "form-control"
                                            v-model = "form.name"
                                            name = "name"
                                            id = "name"
                                            placeholder = "·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ ·ûà·üí·ûò·üÑ·üá·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö"
                                            autocomplete = "name"
                                            autofocus
                                            required
                                        />
                                    </div>
                                </div>
                                <div class = "col-md-12">
                                    <div class = "form-group">
                                        <label for = "name"
                                        >·ûà·üí·ûò·üÑ·üá·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö(·ûá·û∂·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö)</label
                                        >
                                        <input
                                            type = "text"
                                            class = "form-control"
                                            v-model = "form.name_kh"
                                            name = "name_kh"
                                            id = "name_kh"
                                            placeholder = "·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ ·ûà·üí·ûò·üÑ·üá·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö(·ûá·û∂·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö)"
                                            autocomplete = "name_kh"
                                            autofocus
                                            required
                                        />
                                    </div>
                                </div>

                                <!--                          <div class = "col-md-12">-->
                                <!--                              <div class = "form-group">-->
                                <!--                                  <label for = "category_id">·ûî·üí·ûö·ûó·üÅ·ûë</label>-->
                                <!--                                  <select name = "category_id" id = "category_id" class = "form-control"-->
                                <!--                                          v-model = "form.category_id">-->
                                <!--                                      <option value = "·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü ·ûî·üí·ûö·ûó·üÅ·ûë·ûò·üí·û†·ûº·ûò-·û¢·û∂·û†·û∂·ûö">·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü ·ûî·üí·ûö·ûó·üÅ·ûë·ûò·üí·û†·ûº·ûò-·û¢·û∂·û†·û∂·ûö</option>-->
                                <!--                                      <option v-for = "category in categories" :key = "category.id"-->
                                <!--                                              value = "{{ category.id}}" >-->
                                <!--                                                {{ category.name_kh }}-->
                                <!--                                      </option>-->
                                <!--                                  </select>-->
                                <!--                              </div>-->
                                <!--                          </div>-->
                                <div class = "col-md-12">
                                    <div class = "form-group">
                                        <label for = "price">·ûè·ûò·üí·ûõ·üÉ (·ûö·üÄ·ûõ)</label>
                                        <input
                                            type = "number"
                                            class = "form-control"
                                            v-model = "form.price"
                                            name = "price"
                                            id = "price"
                                            maxlength = "12"
                                            placeholder = "·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ ·ûè·ûò·üí·ûõ·üÉ"
                                            autocomplete = "price"
                                        />
                                    </div>
                                </div>
                                <div class = "col-md-12">
                                    <div class = "form-group">
                                        <label for = "photo">·ûö·ûº·ûî·ûó·û∂·ûñ</label>
                                        <input
                                            type = "file"
                                            class = "form-control"
                                            name = "photo"
                                            id = "photo"
                                            @change = "onChangeVal"
                                        />
                                    </div>
                                </div>
                                <div class = "col-md-12">
                                    <div class = "form-group">
                                        <label for = "price">·ûî·ûö·û∑·ûô·û∂·ûô</label>
                                        <textarea
                                            type = "text"
                                            class = "form-control"
                                            v-model = "form.noted"
                                            name = "noted"
                                            id = "noted"
                                            placeholder = "·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ ·ûî·ûö·û∑·ûô·û∂·ûô"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class = "modal-footer justify-content-between">
                        <button
                            v-show = "!method"
                            type = "button"
                            class = "btn btn-danger btn-sm"
                            data-dismiss = "modal"
                        >
                            <i class = "fas fa-backspace"></i> ·ûî·üÑ·üá·ûî·ûÑ·üã
                        </button>
                        <button
                            type = "button"
                            class = "btn btn-secondary btn-sm"
                            @click = "saveData()"
                        >
                            <i class = "fas fa-save"></i> ·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ
                        </button>
                        <button
                            type = "submit"
                            v-show = "method"
                            class = "btn btn-success btn-sm"
                            @click = "updateData()"
                        >
                            <i class = "fas fa-redo"></i> ·ûÄ·üÇ·ûî·üí·ûö·üÇ·ûá·û∂·ûê·üí·ûò·û∏
                        </button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
    </div>
</template>
<script>
import $ from "jquery";
import Form from "vform";

export default {
    components: { DataTable},
    props: ["token"],
    data() {
        return {
            datas: [],
            categories: {},
            method: false,
            headers: [
                {text: "·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ", val: "action"},
                {text: "·ûõ·üÅ·ûÅ·ûö·üÄ·ûÑ", val: "id"},
                {text: "·ûà·üí·ûò·üÑ·üá·ûï·ûõ·û∑·ûè·ûï·ûõ", val: "name"},
                {text: "·ûö·ûº·ûî·ûó·û∂·ûñ", val: "photo"},
                // {text: "·ûà·üí·ûò·üÑ·üá·ûî·üí·ûö·ûó·üÅ·ûë·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö", val: "category_id"},
                {text: "·ûè·ûò·üí·ûõ·üÉ", val: "price"},
                {text: "·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè", val: "created_at"},
                {text: "·ûî·ûö·û∑·ûô·û∂·ûô", val: "noted"},
            ],
            columns: [
                {
                    title: "·ûü·ûÄ·ûò·üí·ûò·ûó·û∂·ûñ", data: null,
                    render: row =>{
                        return `<button data-id="${row.id}" class="btn btn-warning btn-edit btn-sm btn-rounded">
                                    <span class="fas fa-edit"></span>
                                </button>
                                 <b></b>
                                <button data-id="${row.id}" class="btn btn-danger btn-remove btn-sm btn-rounded">
                                        <span class="fas fa-trash-alt"></span>
                                </button>`;
                        }
                },
                {
                    title: "·ûõ·üÅ·ûÅ·ûö·üÄ·ûÑ", data: null,
                    render: (data, type, row, meta) =>{
                            return `${meta.row + 1}`
                        }
                },
                {
                    title: "·ûà·üí·ûò·üÑ·üá·ûî·üí·ûö·ûó·üÅ·ûë·ûò·üí·û†·ûº·ûî-·û¢·û∂·û†·û∂·ûö", data: null,
                    render: row =>{
                        return `${row.name} | ${row.name_kh}`;
                        }
                },
                {
                    title: "·ûö·ûº·ûî·ûó·û∂·ûñ", data: "photo",
                    render: row => {
                        if (!row) {
                            return "<img src='images/avatar.png' class='rounded-circle'  width='40px'/>";
                        }  
                            return "<img src='images/foods/"+ row +"' class='rounded-circle'  width='40px'/>";
                         
                    }
                        
                },
                {
                    title: "·ûè·ûò·üí·ûõ·üÉ", data: "price",
                    render: row =>{
                            return `${row}<sup>·üõ</sup>`;
                        }
                },
                {
                    title: "·ûî·û∂·ûì·ûî·ûÑ·üí·ûÄ·ûæ·ûè", data: "created_at",
                    render: row => {
                        if (row){
                            return moment(row).fromNow();
                        }
                            return "";
                       }
                },
                {
                    title: "·ûî·û∂·ûì·ûÄ·üÇ·ûî·üí·ûö·üÇ", data: "updated_at",
                    render: row => {
                        if (row){
                            return moment(row).fromNow();
                        }
                            return "";
                       }
                },
                {
                    title: "·ûî·ûö·û∑·ûô·û∂·ûô", data: "noted"
                }
            ],
            buttons: [
                {
                    title: "Report of Customers",
                    extend: "excelHtml5",
                    text: "<i class='fa fa-file-excel'> </i> Excel",
                    className: 'btn btn-success btn-sm mt-2'
                },
                {
                    title: "Report of Customers",
                    extend: "pdfHtml5",
                    text: "<i class='fa fa-file-pdf'> </i> PDF",
                    className: 'btn btn-danger btn-sm mt-2'
                },
                {
                    title: "Report of Customers",
                    extend: "print",
                    text: "<i class='fa fa-print'> </i> Import",
                    className: 'btn btn-dark btn-sm mt-2'
                },
                {
                    title: "Report of Customers",
                    extend: "copy",
                    text: "<i class='fa fa-copy'> </i> Copy Text",
                    className: 'btn btn-primary btn-sm mt-2'
                },
            ],
            form: new Form({
                id: "",
                name: "",
                name_kh: "",
                category_id: 1,
                price: '',
                noted: "",
                photo: "",
                _token: this.token.value,
            }),
        };
    },
    mounted() {
        this.fetchData();
        this.getData();

         // Attach event listeners to the action buttons
         $(this.$el).on('click', '.btn-edit', event => {
            const id = $(event.currentTarget).data('id');
            this.editData(id);
        });

        $(this.$el).on('click', '.btn-remove', event => {
            const id = $(event.currentTarget).data('id');
            this.removeData(id);
        });
    },
    methods: {
        async refreshData() {
            location.reload();
        },
        async fetchData() {
            await axios
                .get("api/v1/products")
                .then(response => {
                    this.datas = response.data;
                }).catch(err => console.log(err));
        },
        addNew() {
            this.method = false;
            this.form.reset();
            $("#data-modal").modal("show");
        },
        async saveData() {
            await this.form
                .post('api/v1/products')
                .then(response => {
                    $("#data-modal").modal("hide");
                    this.$swal({
                        position: "top-end",
                        icon: "success",
                        title: "·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûö·ûî·ûü·üã·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô üòç!",
                        showConfirmButton: false,
                        timer: 2000,
                    });
                    // location.reload();
                    this.fetchData();
                    console.log(response.data);
                }) .catch(err => console.log(err));
        },
        editData(id) {
            this.method = true;
            this.form.reset();
            this.form.fill(this.datas.find(row => row.id === id));
            this.form._token = this.token.value;
            $("#data-modal").modal("show");
        },
        async updateData() {
           await this.form
                .put("api/v1/products/" + this.form.id)
                .then(response => {
                    $("#data-modal").modal("hide");
                    this.$swal({
                        position: "top-end",
                        icon: "success",
                        title: "·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûö·ûî·ûü·üã·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûÄ·üÇ·ûî·üí·ûö·üÇ·ûä·üÑ·ûô·ûá·üÑ·ûÇ·ûá·üê·ûô üòç!",
                        showConfirmButton: false,
                        timer: 2000,
                    });
                    // location.reload();
                    this.fetchData();
                    console.log(response);
                }).catch(err => console.log(err));
        },
        removeData(id) {
            this.$swal({
                title: "·ûè·ûæ·û¢·üí·ûì·ûÄ·ûî·üí·ûö·û∂·ûÄ·ûä·û¨·ûë·üÅ?",
                text: "·û¢·üí·ûì·ûÄ·ûì·ûπ·ûÑ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûè·üí·ûö·û°·ûî·üã·ûò·ûÄ·ûú·û∑·ûâ·ûî·û∂·ûì·ûë·üÅ !",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "·ûô·ûõ·üã·ûñ·üí·ûö·ûò",
                cancelButtonText: "·ûî·üÑ·üá·ûî·ûÑ·üã",
                reverseButtons: true,
            }).then(async result => {
                if (result.isConfirmed) {
                    await this.form
                        .delete("api/v1/products/" + id)
                        .then(response => {
                            this.$swal(
                                "·ûõ·ûª·ûî·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã·û†·ûæ·ûô !",
                                "·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûö·ûî·ûü·üã·û¢·üí·ûì·ûÄ·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûõ·ûª·ûî·ûÖ·üÑ·ûõ·û†·ûæ·ûô·üî",
                                "success"
                            );
                            // location.reload();
                            this.fetchData();
                            console.warn(response);
                        }).catch(err => console.warn(err));                      
                } else if (result.dismiss === this.$swal.DismissReason.cancel) {
                    this.$swal(
                        "·ûî·û∂·ûì·ûî·üÑ·üá·ûî·ûÑ·üã",
                        "·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûö·ûî·ûü·üã·û¢·üí·ûì·ûÄ·ûÇ·û∫·ûì·üÖ·ûü·ûª·ûú·ûè·üí·ûê·ûó·û∂·ûñ·ûä·ûä·üÇ·ûõ :)",
                        "error"
                    );
                }
            });
        },
        onChangeVal(event) {
            let files = event.target.files;
            if (!files.length) return;

            let reader = new FileReader();
            reader.onload = (file) => {
                this.form.photo = file.target.result;
            };
            reader.readAsDataURL(files[0]);
        },
        async getData() {
            await axios.get("api/v1/categories")
                       .then(response => {
                this.categories = response.data;
            }).catch(err => console.warn(err));
        },
    },
};
</script>

